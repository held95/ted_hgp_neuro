<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Visualizador TED - Plataforma</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin:12px; background:#f5f5f5; }
    h1 { text-align:center; margin-bottom:10px; }
    input, select, button { padding:8px; margin:6px 6px 6px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .filter-section, .edit-section { background:white; padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,0.04); }
    table { width:100%; border-collapse:collapse; background:white; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#efefef; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab { padding:8px 14px; background:#ddd; border-radius:8px 8px 0 0; cursor:pointer; user-select:none; border:1px solid #ccc; }
    .tab.active { background:white; font-weight:700; border-bottom:1px solid white; }
    .tab-content { background:white; padding:12px; border:1px solid #ccc; border-radius:0 10px 10px 10px; }
    #plantoesBody tr.selected, #vascularTableBody tr.selected { background:#a3d5ff; }
    #calendar { max-width:100% !important; width:100% !important; margin:0 auto; }
    .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .chart-card { background:white; padding:10px; border-radius:8px; border:1px solid #ddd; }
    @media(max-width:900px){ .charts-grid { grid-template-columns:1fr; } }
    .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
  </style>

  <!-- FullCalendar (CSS + JS) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- html2canvas + jsPDF (para gerar PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Visualizador TED / Mutirão / Plantões</h1>

  <!-- filtros / export -->
  <div class="filter-section">
    <div class="row" style="width:100%;">
      <input type="text" id="searchInput" placeholder="Pesquisa global (nome, crm, especialidade) — digite para filtrar..." style="flex:1;" />
      <label for="dataInicio">Data Início:</label>
      <input type="date" id="dataInicio" />
      <label for="dataFim">Data Fim:</label>
      <input type="date" id="dataFim" />
      <button onclick="filtrarTudo()">Filtrar</button>
      <button onclick="resetarTudo()">Resetar</button>

      <div class="right">
        <button onclick="exportarCSV()">Exportar CSV</button>
        <button onclick="gerarPDF()">Gerar PDF (aba ativa)</button>
      </div>
    </div>
  </div>

  <!-- editar horas -->
  <div class="edit-section">
    <div class="row" style="align-items:center;">
      <div>
        <strong>Editar Horas (Selecionar linhas na aba "Resumo Plantão" ou "Eletivas Vascular")</strong><br/>
        <input type="number" id="horasInput" step="0.01" min="0" placeholder="Horas (ex: 2.5)" />
        <button onclick="salvarHoras()">Salvar Alteração</button>
      </div>
      <div style="margin-left:12px;">
        <small>Selecione múltiplas linhas com Ctrl/Cmd + clique. Após editar, clique em salvar.</small>
      </div>
    </div>
  </div>

  <!-- abas -->
  <div class="tabs">
    <div class="tab active" id="tab-ted" onclick="showTab('ted')">Dados TED + Mutirão</div>
    <div class="tab" id="tab-plantao" onclick="showTab('plantao')">Resumo Plantão HOSP NCR - PLANT</div>
    <div class="tab" id="tab-vascular" onclick="showTab('vascular')">Eletivas Vascular</div>
    <div class="tab" id="tab-graficos" onclick="showTab('graficos')">Painel de Gráficos</div>
  </div>

  <!-- conteúdo abas -->
  <div id="tabContent-ted" class="tab-content">
    <table id="dataTable">
      <thead>
        <tr><th>Nome</th><th>CRM</th><th>Especialidade</th><th>Valor ELET</th><th>Valor Amb</th><th>Mutirão</th><th>Horas Neuro</th></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="tabContent-plantao" class="tab-content" style="display:none;">
    <div style="margin-bottom:10px;">
      <button id="toggleCalendarBtn" onclick="toggleCalendario()">Alternar para Calendário</button>
    </div>

    <table id="plantoesTable" style="display:table;">
      <thead>
        <tr>
          <th>Data</th><th>Per</th><th>DS</th><th>Quem Realizou</th><th>CRM</th><th>Função</th><th>Especialidade</th><th>Entrada</th><th>Saída</th><th>Horas</th><th>Valor Hora</th><th>Valor Total R$</th>
        </tr>
      </thead>
      <tbody id="plantoesBody"></tbody>
    </table>

    <div id="calendar" style="display:none; margin-top:20px;"></div>
  </div>

  <div id="tabContent-vascular" class="tab-content" style="display:none;">
    <table id="vascularTable">
      <thead id="vascularTableHead"></thead>
      <tbody id="vascularTableBody"></tbody>
    </table>
  </div>

  <div id="tabContent-graficos" class="tab-content" style="display:none;">
    <div class="row" style="margin-bottom:8px; align-items:center;">
      <label>Período (gráficos):</label>
      <input type="date" id="chartInicio" />
      <input type="date" id="chartFim" />
      <button onclick="aplicarPeriodoGraficos()">Aplicar</button>
      <div class="right"><small>Gráficos refletem filtros e edição.</small></div>
    </div>

    <div class="charts-grid">
      <div class="chart-card"><h4>Horas por Médico</h4><canvas id="chartHorasMedico" height="220"></canvas></div>
      <div class="chart-card"><h4>Valores por Especialidade</h4><canvas id="chartValoresEspecialidade" height="220"></canvas></div>
      <div class="chart-card" style="grid-column:1 / -1"><h4>Evolução diária de horas</h4><canvas id="chartEvolucao" height="140"></canvas></div>
    </div>
  </div>

<script>
  // ---------- estado ----------
  let jsonData = [], mutiraoData = [], plantoesData = [], eletivasVascularData = [];
  let calendarInstance = null, calendarioVisivel = false;
  let chartHorasMedico = null, chartValoresEspecialidade = null, chartEvolucao = null;

  // ---------- helpers ----------
  function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
  function msgErro(e){ console.error(e); alert("Erro (veja console): " + (e && e.message ? e.message : e)); }

  // ---------- carregar dados ----------
  async function loadData(){
    try{
      const resp = await fetch("dados.json");
      if(!resp.ok) throw new Error("dados.json não encontrado (status " + resp.status + "). Coloque o arquivo no mesmo diretório.");
      const data = await resp.json();
      jsonData = data.TED_teste || [];
      mutiraoData = data.Mutirao || [];
      plantoesData = data.Resumo_Plantao_HOSP_NCR_PLANT || [];
      eletivasVascularData = data["HOSP VASC - 16-06-25 a 15-07-25"] || [];

      renderTable(jsonData);
      renderPlantoes(plantoesData);
      renderEletivasVascular(eletivasVascularData);
      inicializarGraficos();
    }catch(e){ msgErro(e); }
  }

  // ---------- render TED ----------
  function renderTable(data){
    const somaHorasPorMed = {};
    plantoesData.forEach(it=>{
      const nome = (it["QUEM REALIZOU"]||"").trim().toLowerCase();
      somaHorasPorMed[nome] = (somaHorasPorMed[nome]||0) + converterTempoDecimal(it.HS||"00:00:00");
    });

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    (data||[]).forEach(entry=>{
      if(!entry || !entry.Nome) return;
      const nomeKey = (entry.Nome||"").trim().toLowerCase();
      const hn = somaHorasPorMed[nomeKey] || 0;
      entry["Horas Neuro"] = hn;
      const row = `<tr>
        <td>${entry.Nome||""}</td>
        <td>${entry.CRM||""}</td>
        <td>${entry.ESPECIALIDADE||""}</td>
        <td>${entry["Valor ELET"]||0}</td>
        <td>${(entry["Valor Amb"]||0).toFixed ? (entry["Valor Amb"]||0).toFixed(2) : entry["Valor Amb"]||0}</td>
        <td>${entry.Mutirão||""}</td>
        <td>${hn.toFixed(2)}</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  }

  // ---------- render plantoes ----------
  function renderPlantoes(data){
    const tbody = document.getElementById("plantoesBody");
    tbody.innerHTML = "";
    (data||[]).forEach(item=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.DATA||""}</td>
        <td>${item.PER||""}</td>
        <td>${item.DS||""}</td>
        <td>${item["QUEM REALIZOU"]||""}</td>
        <td>${item.CRM||""}</td>
        <td>${item.FUNCÃO||""}</td>
        <td>${item.ESPECIALIDADE||""}</td>
        <td>${item.ENTRADA||""}</td>
        <td>${item.SAIDA||""}</td>
        <td>${item.HS||""}</td>
        <td>${item["VALOR HORA"]||""}</td>
        <td>${item["VALOR TOTAL R$"]||""}</td>
      `;
      tr.addEventListener("click", function(e){
        if(e.ctrlKey || e.metaKey) this.classList.toggle("selected");
        else { clearSelection(); this.classList.add("selected"); }
      });
      tbody.appendChild(tr);
    });
  }

  // ---------- render eletivas vascular ----------
  function renderEletivasVascular(data){
    const thead = document.getElementById("vascularTableHead");
    const tbody = document.getElementById("vascularTableBody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    if(!data || data.length < 5) {
      tbody.innerHTML = "<tr><td colspan='30'>Nenhum dado disponível.</td></tr>";
      return;
    }

    // Linha 3 (índice 3) contém os cabeçalhos
    const headerObj = data[3];
    const colunas = Object.keys(headerObj);

    // Criar header da tabela
    let trHead = "<tr>";
    colunas.forEach(col => {
      trHead += "<th>" + headerObj[col] + "</th>";
    });
    trHead += "</tr>";
    thead.innerHTML = trHead;

    // As linhas de dados começam da linha 4 (índice 4)
    for(let i = 4; i < data.length; i++){
      const row = data[i];
      if(row == null) continue;

      let tr = "<tr>";
      colunas.forEach(col => {
        let val = row[col];
        if(val == null || val === " ") val = "";
        tr += "<td>" + val + "</td>";
      });
      tr += "</tr>";
      tbody.insertAdjacentHTML("beforeend", tr);
    }

    // Adiciona seleção das linhas para edição (Ctrl/Cmd + clique)
    Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
      tr.addEventListener("click", e => {
        if(e.ctrlKey || e.metaKey) tr.classList.toggle("selected");
        else {
          tbody.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
          tr.classList.add("selected");
        }
      });
    });
  }

  // ---------- util tempo ----------
  function converterTempoDecimal(hhmmss){
    if(hhmmss == null) return 0;
    const s = String(hhmmss).trim();
    if(!s) return 0;
    const parts = s.split(":");
    if(parts.length === 1){ const v = parseFloat(s.replace(",", ".")); return isNaN(v)?0:v; }
    const h = parseInt(parts[0],10)||0, m = parseInt(parts[1],10)||0, sec = parseInt(parts[2]||0,10)||0;
    return h + m/60 + sec/3600;
  }
  function converterDecimalParaHHMMSS(decimalHours){
    const h = Math.floor(decimalHours), m = Math.floor((decimalHours - h) * 60), s = Math.round(((decimalHours - h) * 60 - m) * 60);
    const pad = n => String(n).padStart(2,'0'); return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  // ---------- salvar horas ----------
  function salvarHoras(){
    try{
      let v = (document.getElementById("horasInput").value || "").replace(",",".").trim();
      const valor = parseFloat(v);
      if(isNaN(valor) || valor < 0){ alert("Informe um valor válido"); return; }

      const abaAtiva = document.querySelector(".tab.active").id.replace("tab-", "");
      let selecionadas = [];

      if(abaAtiva === "plantao"){
        selecionadas = Array.from(document.querySelectorAll("#plantoesBody tr.selected"));
        if(selecionadas.length === 0){ alert("Selecione ao menos uma linha"); return; }
        selecionadas.forEach(row=>{
          const cells = row.children;
          const dataLinha = (cells[0].textContent || "").trim().split(" ")[0] || "";
          const crmLinha = String((cells[4].textContent || "").trim());
          for(let i=0; i<plantoesData.length; i++){
            const it = plantoesData[i];
            const dataIt = String(it.DATA||"").split(" ")[0] || "";
            if(String(it.CRM) === crmLinha && dataIt === dataLinha){
              it.HS = converterDecimalParaHHMMSS(valor);
            }
          }
        });
        renderPlantoes(plantoesData);
      }
      else if(abaAtiva === "vascular"){
        selecionadas = Array.from(document.querySelectorAll("#vascularTableBody tr.selected"));
        if(selecionadas.length === 0){ alert("Selecione ao menos uma linha"); return; }
        selecionadas.forEach(row=>{
          const cells = row.children;
          const dataProc = (cells[0].textContent || "").trim();
          const paciente = (cells[2].textContent || "").trim();

          for(let i=0; i<eletivasVascularData.length; i++){
            const it = eletivasVascularData[i];
            if(!it) continue;
            if(it["Unnamed: 0"] === dataProc && it["Unnamed: 2"] === paciente){
              // Criando/Atualizando a chave "Horas" na linha do dado
              it.Horas = valor;
            }
          }
        });
        renderEletivasVascular(eletivasVascularData);
      } else {
        alert("A edição de horas só está habilitada para as abas 'Resumo Plantão' e 'Eletivas Vascular'");
        return;
      }

      atualizarHorasNeuro();
      alert("Horas atualizadas com sucesso!");
    }catch(e){ msgErro(e); }
  }

  function clearSelection(){
    document.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
  }

  // ---------- atualizar Horas Neuro na aba TED ----------
  function atualizarHorasNeuro(){
    // Recalcular soma das horas no resumo plantão e atualizar a tabela TED
    const somaHorasPorMed = {};
    plantoesData.forEach(it=>{
      const nome = (it["QUEM REALIZOU"]||"").trim().toLowerCase();
      somaHorasPorMed[nome] = (somaHorasPorMed[nome]||0) + converterTempoDecimal(it.HS||"00:00:00");
    });
    jsonData.forEach(entry=>{
      const nomeKey = (entry.Nome||"").trim().toLowerCase();
      const hn = somaHorasPorMed[nomeKey] || 0;
      entry["Horas Neuro"] = hn;
    });
    renderTable(jsonData);
  }

  // ---------- showTab ----------
  function showTab(tab){
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");

    document.getElementById("tab-" + tab).classList.add("active");
    document.getElementById("tabContent-" + tab).style.display = "block";

    if(tab === "vascular"){
      renderEletivasVascular(eletivasVascularData);
    }
    else if(tab === "plantao"){
      renderPlantoes(plantoesData);
    }
  }

  // ---------- filtros ----------
  function filtrarTudo(){
    try{
      const busca = (document.getElementById("searchInput").value || "").toLowerCase().trim();
      const dtIni = document.getElementById("dataInicio").value;
      const dtFim = document.getElementById("dataFim").value;

      // filtrar dados TED e mutirão
      const filteredTED = jsonData.filter(entry=>{
        if(!entry) return false;
        if(busca){
          const fields = [entry.Nome, entry.CRM, entry.ESPECIALIDADE].map(s=>String(s||"").toLowerCase());
          if(!fields.some(f=>f.includes(busca))) return false;
        }
        return true;
      });

      // filtrar plantoes pelo intervalo de datas
      let filteredPlantoes = plantoesData;
      if(dtIni || dtFim){
        filteredPlantoes = plantoesData.filter(it=>{
          if(!it.DATA) return false;
          const d = new Date(it.DATA);
          if(dtIni && d < new Date(dtIni)) return false;
          if(dtFim && d > new Date(dtFim)) return false;
          return true;
        });
      }

      // filtrar vascular - mesma lógica do plantao
      let filteredVascular = eletivasVascularData;
      if(dtIni || dtFim){
        filteredVascular = eletivasVascularData.filter(it=>{
          if(!it["Unnamed: 0"]) return false;
          const d = new Date(it["Unnamed: 0"]);
          if(dtIni && d < new Date(dtIni)) return false;
          if(dtFim && d > new Date(dtFim)) return false;
          return true;
        });
      }

      renderTable(filteredTED);
      renderPlantoes(filteredPlantoes);
      renderEletivasVascular(filteredVascular);
    }catch(e){ msgErro(e); }
  }
  function resetarTudo(){
    document.getElementById("searchInput").value = "";
    document.getElementById("dataInicio").value = "";
    document.getElementById("dataFim").value = "";
    renderTable(jsonData);
    renderPlantoes(plantoesData);
    renderEletivasVascular(eletivasVascularData);
  }

  // ---------- calendário plantao ----------
  function toggleCalendario(){
    calendarioVisivel = !calendarioVisivel;
    document.getElementById("plantoesTable").style.display = calendarioVisivel ? "none" : "table";
    document.getElementById("calendar").style.display = calendarioVisivel ? "block" : "none";
    document.getElementById("toggleCalendarBtn").textContent = calendarioVisivel ? "Alternar para Lista" : "Alternar para Calendário";

    if(calendarioVisivel){
      initCalendar();
    }
  }

  function initCalendar(){
    if(calendarInstance) return;
    const calendarEl = document.getElementById("calendar");
    calendarInstance = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 400,
      locale: 'pt-br',
      events: plantoesData.map(ev=>{
        return {
          title: ev["QUEM REALIZOU"] + " (" + (ev.HS||"") + "h)",
          start: ev.DATA,
          allDay: true
        };
      }),
      eventColor: '#378006'
    });
    calendarInstance.render();
  }

  // ---------- gráficos ----------
  function inicializarGraficos(){
    if(chartHorasMedico) chartHorasMedico.destroy();
    if(chartValoresEspecialidade) chartValoresEspecialidade.destroy();
    if(chartEvolucao) chartEvolucao.destroy();

    const ctxHoras = document.getElementById("chartHorasMedico").getContext("2d");
    const ctxValores = document.getElementById("chartValoresEspecialidade").getContext("2d");
    const ctxEvolucao = document.getElementById("chartEvolucao").getContext("2d");

    const horasMedicoMap = {};
    const valorEspecialidadeMap = {};
    const evolucaoMap = {};

    plantoesData.forEach(it=>{
      const nome = it["QUEM REALIZOU"]||"";
      const especialidade = it.ESPECIALIDADE||"";
      const horas = converterTempoDecimal(it.HS||"00:00:00");
      const valorTotal = parseFloat(it["VALOR TOTAL R$"]||0);

      horasMedicoMap[nome] = (horasMedicoMap[nome]||0) + horas;
      valorEspecialidadeMap[especialidade] = (valorEspecialidadeMap[especialidade]||0) + valorTotal;

      const dataStr = (it.DATA||"").split(" ")[0];
      if(!dataStr) return;
      evolucaoMap[dataStr] = (evolucaoMap[dataStr]||0) + horas;
    });

    const labelsHorasMedico = Object.keys(horasMedicoMap);
    const dataHorasMedico = labelsHorasMedico.map(l => horasMedicoMap[l]);

    const labelsValorEsp = Object.keys(valorEspecialidadeMap);
    const dataValorEsp = labelsValorEsp.map(l => valorEspecialidadeMap[l]);

    const labelsEvolucao = Object.keys(evolucaoMap).sort();
    const dataEvolucao = labelsEvolucao.map(d => evolucaoMap[d]);

    chartHorasMedico = new Chart(ctxHoras, {
      type: 'bar',
      data: { labels: labelsHorasMedico, datasets: [{label:'Horas', data: dataHorasMedico, backgroundColor: 'rgba(54, 162, 235, 0.7)'}] },
      options: { responsive:true, plugins: {legend:{display:false}} }
    });
    chartValoresEspecialidade = new Chart(ctxValores, {
      type: 'bar',
      data: { labels: labelsValorEsp, datasets: [{label:'Valor Total R$', data: dataValorEsp, backgroundColor: 'rgba(255, 159, 64, 0.7)'}] },
      options: { responsive:true, plugins: {legend:{display:false}} }
    });
    chartEvolucao = new Chart(ctxEvolucao, {
      type: 'line',
      data: { labels: labelsEvolucao, datasets: [{label:'Horas Diárias', data: dataEvolucao, borderColor:'rgba(75, 192, 192, 1)', fill:false, tension:0.3}] },
      options: { responsive:true, scales: { x: {type: 'time', time: {unit: 'day', tooltipFormat:'dd/MM/yyyy'}} } }
    });
  }

  function aplicarPeriodoGraficos(){
    // Para simplificação, apenas re-renderizar tudo, pois já há filtro por data implementado para tabelas
    // No futuro, você pode refinar para filtrar os dados plantoesData conforme datas escolhidas
    alert("Filtro por período nos gráficos ainda não implementado. Recarregando todos os dados.");
    inicializarGraficos();
  }

  // ---------- exportar csv ----------
  function exportarCSV(){
    const abaAtiva = document.querySelector(".tab.active").id.replace("tab-", "");
    let csv = "", filename = "export.csv";
    if(abaAtiva === "ted"){
      csv = arrayToCSV(jsonData, ["Nome", "CRM", "ESPECIALIDADE", "Valor ELET", "Valor Amb", "Mutirão", "Horas Neuro"]);
      filename = "TED_Mutirao.csv";
    } else if(abaAtiva === "plantao"){
      csv = arrayToCSV(plantoesData, ["DATA","PER","DS","QUEM REALIZOU","CRM","FUNCÃO","ESPECIALIDADE","ENTRADA","SAIDA","HS","VALOR HORA","VALOR TOTAL R$"]);
      filename = "Resumo_Plantao.csv";
    } else if(abaAtiva === "vascular"){
      if(eletivasVascularData.length > 4){
        const keys = Object.keys(eletivasVascularData[3]);
        csv = arrayToCSV(eletivasVascularData.slice(4), keys);
      }
      filename = "Eletivas_Vascular.csv";
    } else {
      alert("Exportação não disponível para esta aba.");
      return;
    }
    downloadCSV(csv, filename);
  }

  function arrayToCSV(arr, headers){
    if(!arr || arr.length === 0) return "";
    const csvRows = [];
    csvRows.push(headers.join(","));
    for(const row of arr){
      const line = headers.map(h=>{
        const v = row[h];
        if(v == null) return "";
        const s = String(v).replace(/"/g, '""');
        return `"${s}"`;
      }).join(",");
      csvRows.push(line);
    }
    return csvRows.join("\r\n");
  }

  function downloadCSV(csv, filename){
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  }

  // ---------- gerar PDF da aba ativa ----------
  async function gerarPDF(){
    const abaAtiva = document.querySelector(".tab.active").id.replace("tab-", "");
    const divContent = document.getElementById("tabContent-" + abaAtiva);
    if(!divContent){
      alert("Erro ao gerar PDF: aba não encontrada.");
      return;
    }
    const canvas = await html2canvas(divContent, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save("relatorio_" + abaAtiva + ".pdf");
  }

  // ---------- inicialização ----------
  window.onload = () => {
    loadData();
    // Definir aba inicial
    showTab("ted");
  };
</script>

</body>
</html>
