<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Visualizador TED / Mutirão / Plantões / Eletivas</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body { font-family: Arial, sans-serif; margin:12px; background:#f5f5f5; }
h1 { text-align:center; margin-bottom:10px; }
input, select, button { padding:8px; margin:6px 6px 6px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; }
.row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.filter-section, .edit-section { background:white; padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,0.04); }
table { width:100%; border-collapse:collapse; background:white; margin-top:10px; }
th, td { border:1px solid #ccc; padding:8px; text-align:left; }
th { background:#efefef; }
.tabs { display:flex; gap:8px; margin-bottom:10px; }
.tab { padding:8px 14px; background:#ddd; border-radius:8px 8px 0 0; cursor:pointer; user-select:none; border:1px solid #ccc; }
.tab.active { background:white; font-weight:700; border-bottom:1px solid white; }
.tab-content { background:white; padding:12px; border:1px solid #ccc; border-radius:0 10px 10px 10px; }
#plantoesBody tr.selected, #eletivasBody tr.selected { background:#a3d5ff; }
#calendar { max-width:100% !important; width:100% !important; margin:0 auto; }
.right { margin-left:auto; display:flex; gap:8px; align-items:center; }
</style>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>
</head>
<body>
<h1>Visualizador TED / Mutirão / Plantões / Eletivas</h1>

<div class="filter-section">
<div class="row" style="width:100%;">
<input type="text" id="searchInput" placeholder="Pesquisa global (nome, crm, especialidade)" style="flex:1;" />
<label for="dataInicio">Data Início:</label>
<input type="date" id="dataInicio"/>
<label for="dataFim">Data Fim:</label>
<input type="date" id="dataFim"/>
<button onclick="filtrarTudo()">Filtrar</button>
<button onclick="resetarTudo()">Resetar</button>
<div class="right">
<button onclick="exportarCSV()">Exportar CSV</button>
</div>
</div>
</div>

<div class="edit-section">
<div class="row" style="align-items:center;">
<div>
<strong>Editar Plantões</strong><br/>
<input type="text" id="horasInput" placeholder="Horas (ex: 12:30:00)"/>
<button onclick="salvarHoras()">Salvar Alteração</button>
</div>
<div>
<strong>Editar Eletivas</strong><br/>
<input type="number" id="valorEletivasInput" step="0.01" min="0" placeholder="Valor R$"/>
<select id="porteInput">
<option value="">- Porte -</option>
<option value="P">P</option>
<option value="M">M</option>
<option value="G">G</option>
</select>
<button onclick="salvarEletivas()">Salvar Alteração</button>
</div>
<div style="margin-left:12px;">
<small>Selecione múltiplas linhas com Ctrl/Cmd + clique. Após editar, clique em salvar.</small>
</div>
</div>
</div>

<div class="tabs">
<div class="tab active" id="tab-ted" onclick="showTab('ted')">Dados TED + Mutirão</div>
<div class="tab" id="tab-plantao" onclick="showTab('plantao')">Resumo Plantão HOSP NCR - PLANT</div>
<div class="tab" id="tab-eletivas" onclick="showTab('eletivas')">Eletivas Vascular</div>
</div>

<div id="tabContent-ted" class="tab-content">
<table id="dataTable">
<thead>
<tr>
<th>Nome</th><th>CRM</th><th>Especialidade</th><th>Valor ELET</th>
<th>Valor Amb</th><th>Mutirão</th><th>Horas Neuro</th><th>Eletivas VASC</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div id="tabContent-plantao" class="tab-content" style="display:none;">
<div style="margin-bottom:10px;">
<button id="toggleCalendarBtn" onclick="toggleCalendario()">Alternar para Calendário</button>
</div>
<table id="plantoesTable" style="display:table;">
<thead>
<tr>
<th>Data</th><th>Per</th><th>DS</th><th>Quem Realizou</th><th>CRM</th><th>Função</th><th>Especialidade</th>
<th>Entrada</th><th>Saída</th><th>Horas</th><th>Valor Hora</th><th>Valor Total R$</th>
</tr>
</thead>
<tbody id="plantoesBody"></tbody>
</table>
<div id="calendar" style="display:none; margin-top:20px;"></div>
</div>

<div id="tabContent-eletivas" class="tab-content" style="display:none;">
<table id="eletivasTable">
<thead>
<tr>
<th>Data do procedimento</th><th>Dia da semana</th><th>Nome do paciente</th><th>Paciente</th><th>RH</th>
<th>Procedimento 1</th><th>Procedimento 2</th><th>Porte</th><th>Valor R$</th>
<th>Médico</th><th>CRM</th><th>Assistentes 1</th>
</tr>
</thead>
<tbody id="eletivasBody"></tbody>
</table>
</div>

<script>
let jsonData=[], plantoesData=[], eletivasData=[], calendarInstance=null, calendarioVisivel=false;

function showTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('tabContent-'+tab).style.display='block';
  if(tab==='plantao' && calendarioVisivel && calendarInstance) calendarInstance.render();
}

async function loadData(){
  try{
    const resp = await fetch('dados.json');
    if(!resp.ok) throw new Error('dados.json não encontrado');
    const data = await resp.json();
    jsonData = data.TED_teste||[];
    plantoesData = data.Resumo_Plantao_HOSP_NCR_PLANT||[];
    eletivasData = data.Eletivas_Vascular||[];
    atualizarTudo();
  }catch(e){ console.error(e); alert('Erro ao carregar dados: '+e.message);}
}

function atualizarTudo(){
  renderTable(jsonData);
  renderPlantoes(plantoesData);
  renderEletivas(eletivasData);
}

// Somatório de Horas por Médico
function calcularHorasNeuro(nome){
  return plantoesData
    .filter(p => p["QUEM REALIZOU"] === nome)
    .reduce((acc,p)=>acc + parseFloat(p.HS || 0),0)
    .toFixed(2);
}

function renderTable(data){
  const tbody=document.getElementById('tableBody'); tbody.innerHTML='';
  data.forEach(it=>{
    const totalEletivas = eletivasData
      .filter(e => e.Médico===it.Nome)
      .reduce((acc,e)=>acc + parseFloat(String(e["Valor R$"]||0)),0);
    const horasNeuro = calcularHorasNeuro(it.Nome);
    const row=`<tr>
      <td>${it.Nome||''}</td>
      <td>${it.CRM||''}</td>
      <td>${it.ESPECIALIDADE||''}</td>
      <td>${it["Valor ELET"]||0}</td>
      <td>${it["Valor Amb"]||0}</td>
      <td>${it.Mutirao||0}</td>
      <td>${horasNeuro}</td>
      <td>${totalEletivas.toFixed(2)}</td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend',row);
  });
}

function renderPlantoes(data){
  const tbody=document.getElementById('plantoesBody'); tbody.innerHTML='';
  data.forEach(it=>{
    const row=`<tr>
      <td>${it.DATA||''}</td><td>${it.PER||''}</td><td>${it.DS||''}</td>
      <td>${it["QUEM REALIZOU"]||''}</td><td>${it.CRM||''}</td>
      <td>${it.FUNCAO||''}</td><td>${it.ESPECIALIDADE||''}</td>
      <td>${it.ENTRADA||''}</td><td>${it.SAIDA||''}</td>
      <td>${it.HS||''}</td><td>${it["VALOR HORA"]||''}</td><td>${it["VALOR TOTAL R$"]||''}</td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend',row);
  });
}

function renderEletivas(data){
  const tbody=document.getElementById('eletivasBody'); tbody.innerHTML='';
  (data||[]).forEach(it=>{
    const row=`<tr>
      <td>${it["Data do procedimento"]||''}</td><td>${it["Dia da semana"]||''}</td>
      <td>${it["Nome do paciente"]||''}</td><td>${it["Paciente"]||''}</td>
      <td>${it["RH"]||''}</td><td>${it["Procedimento 1"]||''}</td>
      <td>${it["Procedimento 2"]||''}</td><td>${it["Porte"]||''}</td>
      <td>${it["Valor R$"]||''}</td><td>${it["Médico"]||''}</td>
      <td>${it["CRM"]||''}</td><td>${it["Assistentes 1"]||''}</td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend',row);
  });
}

function filtrarTudo(){
  const texto = document.getElementById('searchInput').value.toLowerCase();
  const inicio = document.getElementById('dataInicio').value;
  const fim = document.getElementById('dataFim').value;

  function filtrarArray(arr){
    return arr.filter(item=>{
      let matchText = Object.values(item).some(v => String(v).toLowerCase().includes(texto));
      let matchData=true;
      if(item.DATA && inicio) matchData = item.DATA >= inicio;
      if(item.DATA && fim) matchData = matchData && item.DATA <= fim;
      return matchText && matchData;
    });
  }

  renderTable(filtrarArray(jsonData));
  renderPlantoes(filtrarArray(plantoesData));
  renderEletivas(filtrarArray(eletivasData));
}

function resetarTudo(){
  document.getElementById('searchInput').value='';
  document.getElementById('dataInicio').value='';
  document.getElementById('dataFim').value='';
  atualizarTudo();
}

function toggleCalendario(){
  calendarioVisivel = !calendarioVisivel;
  const table = document.getElementById('plantoesTable');
  const calendarEl = document.getElementById('calendar');
  if(calendarioVisivel){
    table.style.display='none';
    calendarEl.style.display='block';
    if(!calendarInstance){
      calendarInstance = new FullCalendar.Calendar(calendarEl,{
        initialView: 'dayGridMonth',
        height:'auto',
        events: plantoesData.map(it=>({
          title: it["QUEM REALIZOU"]+" - "+it.ESPECIALIDADE,
          start: it.DATA,
          extendedProps: { hs: it.HS, valor: it["VALOR TOTAL R$"] }
        }))
      });
    }
    calendarInstance.render();
  }else{
    table.style.display='table';
    calendarEl.style.display='none';
  }
}

document.addEventListener('click',e=>{
  if(e.target.tagName==='TD'){
    const tr=e.target.closest('tr');
    if(tr.parentNode.id==='plantoesBody' || tr.parentNode.id==='eletivasBody'){
      if(!e.ctrlKey && !e.metaKey){
        tr.parentNode.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
      }
      tr.classList.toggle('selected');
    }
  }
});

// Converter HH:MM:SS para horas decimais
function hhmmssToDecimal(hhmmss){
  const parts = hhmmss.split(':').map(Number);
  if(parts.length!==3) return NaN;
  return (parts[0] + parts[1]/60 + parts[2]/3600).toFixed(2);
}

// Salvar alterações Plantões
function salvarHoras(){
  const novaHora = document.getElementById('horasInput').value.trim();
  if(!novaHora) return alert('Insira um horário válido (HH:MM:SS)');
  const horasDec = hhmmssToDecimal(novaHora);
  if(isNaN(horasDec)) return alert('Formato inválido! Use HH:MM:SS');

  document.querySelectorAll('#plantoesBody tr.selected').forEach(tr=>{
    const idx = tr.rowIndex - 1;
    plantoesData[idx].HS = horasDec;
    tr.cells[9].innerText = horasDec;
  });
  atualizarTudo();
}

function salvarEletivas(){
  const val=parseFloat(document.getElementById('valorEletivasInput').value);
  const porte=document.getElementById('porteInput').value;
  if(isNaN(val) && !porte) return alert('Insira Valor R$ ou selecione Porte!');
  document.querySelectorAll('#eletivasBody tr.selected').forEach(tr=>{
    const idx=tr.rowIndex-1;
    if(!isNaN(val)){ eletivasData[idx]["Valor R$"]=val; tr.cells[8].innerText=val; }
    if(porte){ eletivasData[idx]["Porte"]=porte; tr.cells[7].innerText=porte; }
  });
  atualizarTudo();
}

document.addEventListener('DOMContentLoaded',()=>{ loadData(); });
</script>
</body>
</html>
