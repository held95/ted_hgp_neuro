<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel TED + Plantões + Eletivas Vascular</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body{font-family:Arial,sans-serif;margin:12px;}
    .tabs{display:flex;gap:10px;margin-bottom:10px;}
    .tabs button{padding:8px 12px;cursor:pointer;}
    .tabs button.active{background:#007bff;color:white;}
    table{width:100%;border-collapse:collapse;margin-bottom:20px;}
    th,td{border:1px solid #ccc;padding:5px;text-align:left;}
    th{background:#eee;}
    #calendar{max-width:900px;margin:0 auto;display:none;}
  </style>
</head>
<body>

<div class="tabs">
  <button id="tab-ted" class="tab active" onclick="showTab('ted')">Dados TED + Mutirão</button>
  <button id="tab-plantao" class="tab" onclick="showTab('plantao')">Resumo Plantão HOSP NCR - PLANT</button>
  <button id="tab-eletivas" class="tab" onclick="showTab('eletivas')">Eletivas Vascular</button>
  <button id="tab-graficos" class="tab" onclick="showTab('graficos')">Painel de Gráficos</button>
</div>

<div>
  <input type="text" id="searchInput" placeholder="Pesquisar...">
  <input type="date" id="dataInicio"> a <input type="date" id="dataFim">
  <button onclick="filtrarTudo()">Filtrar</button>
  <button onclick="resetarTudo()">Resetar</button>
</div>

<!-- ABA TED + MUTIRÃO -->
<div id="tabContent-ted">
  <table>
    <thead>
      <tr>
        <th>Nome</th><th>CRM</th><th>Especialidade</th><th>Valor ELET</th>
        <th>Valor Amb</th><th>Mutirão</th><th>Horas</th><th>ELET VASC</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- ABA PLANTÃO -->
<div id="tabContent-plantao" style="display:none;">
  <button id="toggleCalendarBtn" onclick="toggleCalendario()">Alternar para Calendário</button>
  <table id="plantoesTable">
    <thead>
      <tr>
        <th>Data</th><th>PER</th><th>DS</th><th>QUEM REALIZOU</th><th>CRM</th>
        <th>FUNCAO</th><th>ESPECIALIDADE</th><th>ENTRADA</th><th>SAIDA</th>
        <th>HS</th><th>VALOR HORA</th><th>VALOR TOTAL</th>
      </tr>
    </thead>
    <tbody id="plantoesBody"></tbody>
  </table>
  <div id="calendar"></div>
</div>

<!-- ABA ELETIVAS VASCULAR -->
<div id="tabContent-eletivas" style="display:none;">
  <table>
    <thead>
      <tr>
        <th>Data do procedimento</th><th>Dia da semana</th><th>Paciente</th><th>Nome do paciente</th>
        <th>RH</th><th>Procedimento 1</th><th>Procedimento 2</th><th>Porte</th><th>Valor R$</th>
        <th>Médico</th><th>CRM</th><th>Assistentes 1</th>
      </tr>
    </thead>
    <tbody id="eletivasBody"></tbody>
  </table>
</div>

<!-- ABA GRÁFICOS -->
<div id="tabContent-graficos" style="display:none;">
  <canvas id="chartHorasMedico"></canvas>
  <canvas id="chartValoresEspecialidade"></canvas>
  <canvas id="chartEvolucao"></canvas>
  <label>Início: <input type="date" id="chartInicio"></label>
  <label>Fim: <input type="date" id="chartFim"></label>
  <button onclick="aplicarPeriodoGraficos()">Aplicar período</button>
</div>

<script>
let jsonData = [];      // Dados TED + Mutirão
let plantoesData = [];  // Resumo Plantão
let eletivasData = [];  // Eletivas Vascular
let calendarioVisivel = false;
let calendarInstance = null;
let chartHorasMedico, chartValoresEspecialidade, chartEvolucao;

// ---------- Utilidades de tempo ----------
function converterTempoDecimal(hhmmss){
  if(!hhmmss) return 0;
  const s = String(hhmmss).trim();
  if(!s) return 0;
  const parts = s.split(":");
  if(parts.length===1){ const v=parseFloat(s.replace(",",".")); return isNaN(v)?0:v; }
  const h=parseInt(parts[0],10)||0,m=parseInt(parts[1],10)||0,sec=parseInt(parts[2]||0,10)||0;
  return h + m/60 + sec/3600;
}
function converterDecimalParaHHMMSS(decimalHours){
  const h=Math.floor(decimalHours), m=Math.floor((decimalHours-h)*60), s=Math.round(((decimalHours-h)*60-m)*60);
  const pad = n=>String(n).padStart(2,'0'); return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

// ---------- Render da Tabela TED + Mutirão ----------
function renderTable(data){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML="";
  data.forEach(item=>{
    const row=`<tr>
      <td>${item.Nome||""}</td>
      <td>${item.CRM||""}</td>
      <td>${item.ESPECIALIDADE||""}</td>
      <td>${item.ValorELET||0}</td>
      <td>${item.ValorAmb||0}</td>
      <td>${item.Mutirao||0}</td>
      <td>${item.Horas||0}</td>
      <td>${item["ELET VASC"]||0}</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend",row);
  });
}

// ---------- Render da Tabela Plantões ----------
function renderPlantoes(data){
  const tbody = document.getElementById("plantoesBody");
  tbody.innerHTML="";
  data.forEach(it=>{
    const row=`<tr>
      <td>${it.DATA||""}</td>
      <td>${it.PER||""}</td>
      <td>${it.DS||""}</td>
      <td>${it["QUEM REALIZOU"]||""}</td>
      <td>${it.CRM||""}</td>
      <td>${it.FUNCAO||""}</td>
      <td>${it.ESPECIALIDADE||""}</td>
      <td>${it.ENTRADA||""}</td>
      <td>${it.SAIDA||""}</td>
      <td>${it.HS||""}</td>
      <td>${it["VALOR HORA"]||0}</td>
      <td>${it["VALOR TOTAL R$"]||0}</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend",row);
  });
}

// ---------- Render Eletivas ----------
function renderEletivas(data){
  const tbody = document.getElementById("eletivasBody");
  tbody.innerHTML="";
  data.forEach(it=>{
    const row=`<tr>
      <td>${it["Data do procedimento"]||""}</td>
      <td>${it["Dia da semana"]||""}</td>
      <td>${it.Paciente||""}</td>
      <td>${it["Nome do paciente"]||""}</td>
      <td>${it.RH||""}</td>
      <td>${it["Procedimento 1"]||""}</td>
      <td>${it["Procedimento 2"]||""}</td>
      <td>${it.Porte||""}</td>
      <td contenteditable="true" oninput="atualizarEletVasc()">${it["Valor R$"]||0}</td>
      <td>${it.Médico||""}</td>
      <td>${it.CRM||""}</td>
      <td>${it["Assistentes 1"]||""}</td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend",row);
  });
}

// ---------- Atualizar ELET VASC ----------
function atualizarEletVasc(){
  // Atualizar valores na jsonData
  // Primeiro ler valores alterados na tabela Eletivas
  const trs = document.querySelectorAll("#eletivasBody tr");
  trs.forEach((tr,i)=>{
    const valCell = tr.children[8];
    const v = parseFloat(valCell.textContent.replace(",",".")||0);
    eletivasData[i]["Valor R$"]=v;
  });

  // Atualizar coluna ELET VASC
  jsonData.forEach(ent=>{
    const medico = (ent.Nome||"").trim();
    const soma = eletivasData
                  .filter(e => (e["Médico"]||"").trim()===medico)
                  .reduce((acc,e)=>acc+(parseFloat(e["Valor R$"]||0)||0),0);
    ent["ELET VASC"] = Number(soma.toFixed(2));
  });
  renderTable(jsonData);
  atualizarGraficosComVisiveis();
}

// ---------- Atualizar Horas ----------
function atualizarHorasNeuro(){
  const soma={};
  plantoesData.forEach(it=>{
    const nome=(it["QUEM REALIZOU"]||"").trim().toLowerCase();
    soma[nome]=(soma[nome]||0)+converterTempoDecimal(it.HS||"00:00:00");
  });
  jsonData.forEach(ent=>{
    const nome=(ent.Nome||"").trim().toLowerCase();
    ent["Horas"]=soma[nome]||0;
  });
  atualizarEletVasc();
}

// ---------- Filtros ----------
function filtrarTudo(){
  const q=(document.getElementById("searchInput").value||"").toLowerCase().trim();
  const di=document.getElementById("dataInicio").value;
  const df=document.getElementById("dataFim").value;

  const filteredTed = jsonData.filter(e=>{
    if(!q) return true;
    return (e.Nome||"").toLowerCase().includes(q) || String(e.CRM||"").includes(q) || (e.ESPECIALIDADE||"").toLowerCase().includes(q);
  });

  const filteredPl = plantoesData.filter(it=>{
    const nome=(it["QUEM REALIZOU"]||"").toLowerCase();
    const crm=String(it.CRM||"");
    const esp=(it.ESPECIALIDADE||"").toLowerCase();
    const dataPart=String(it.DATA||"").split(" ")[0]||"";
    let okText=!q || nome.includes(q) || crm.includes(q) || esp.includes(q);
    let okDate=true;
    if(di) okDate=okDate&&(dataPart>=di);
    if(df) okDate=okDate&&(dataPart<=df);
    return okText && okDate;
  });

  renderTable(filteredTed);
  renderPlantoes(filteredPl);
  renderEletivas(eletivasData);

  if(calendarInstance && calendarioVisivel){
    calendarInstance.removeAllEvents();
    calendarInstance.addEventSource(mapearEventosPlantao(filteredPl));
  }
  atualizarGraficosComVisiveis();
}

function resetarTudo(){
  document.getElementById("searchInput").value="";
  document.getElementById("dataInicio").value="";
  document.getElementById("dataFim").value="";
  renderTable(jsonData);
  renderPlantoes(plantoesData);
  renderEletivas(eletivasData);
  if(calendarInstance && calendarioVisivel){
    calendarInstance.removeAllEvents();
    calendarInstance.addEventSource(mapearEventosPlantao(plantoesData));
  }
  atualizarGraficosComVisiveis();
}

// ---------- Abas ----------
function showTab(key){
  ['ted','plantao','eletivas','graficos'].forEach(k=>{
    document.getElementById('tabContent-'+k).style.display=(k===key)?'block':'none';
    document.getElementById('tab-'+k).classList.toggle('active', k===key);
  });
  if(key==='graficos') atualizarGraficosComVisiveis();
  if(key==='plantao' && calendarioVisivel && calendarInstance) calendarInstance.render();
}

// ---------- Inicialização ----------
document.addEventListener("DOMContentLoaded", loadData);

function loadData(){
  // Exemplo de JSON
  jsonData = [
    {Nome:"BIANCA SOLER MONTAGNER", CRM:200329, ESPECIALIDADE:"Vascular", ValorELET:0, ValorAmb:0, Mutirao:0, Horas:0, "ELET VASC":0}
  ];
  plantoesData = [
    {DATA:"2025-06-16", PER:"1", DS:"segunda", "QUEM REALIZOU":"BIANCA SOLER MONTAGNER", CRM:200329, FUNCAO:"Cirurgião", ESPECIALIDADE:"Vascular", ENTRADA:"08:00", SAIDA:"12:00", HS:"04:00:00", "VALOR HORA":500, "VALOR TOTAL R$":2000}
  ];
  eletivasData = [
    { "Data do procedimento":"2025-06-16","Dia da semana":"segunda","Nome do paciente":"Francisco Soares Filho","Paciente":"F S F","RH":1115350,"Procedimento 1":"TRATAMENTO CIRÚRGICO DE VARIZES","Procedimento 2":"TRATAMENTO ESCLEROSANTE","Porte":"G","Valor R$":1558.95,"Médico":"BIANCA SOLER MONTAGNER","CRM":200329,"Assistentes 1":"" }
  ];

  atualizarHorasNeuro();
  renderPlantoes(plantoesData);
  renderEletivas(eletivasData);
  inicializarGraficos();
}

// ---------- Gráficos ----------
function prepararDadosGraficos(plantoes=[], eletivas=[]){
  plantoes = plantoes.length?plantoes:plantoesData;
  eletivas = eletivas.length?eletivas:eletivasData;

  const horasPorMed={}, valoresPorEsp={}, horasPorData={};

  plantoes.forEach(it=>{
    const nome=it["QUEM REALIZOU"]||"";
    const h=converterTempoDecimal(it.HS||"00:00:00");
    horasPorMed[nome]=(horasPorMed[nome]||0)+h;

    const esp=(it.ESPECIALIDADE||"Sem Esp");
    const v=parseFloat(String(it["VALOR TOTAL R$"]||0))||0;
    valoresPorEsp[esp]=(valoresPorEsp[esp]||0)+v;

    const dt=(String(it.DATA||"").split(" ")[0])||"";
    horasPorData[dt]=(horasPorData[dt]||0)+h;
  });

  eletivas.forEach(it=>{
    const nome=it["Médico"]||"";
    const v=parseFloat(it["Valor R$"]||0)||0;
    valoresPorEsp["ELET VASC"]=(valoresPorEsp["ELET VASC"]||0)+v;
    horasPorMed[nome]=(horasPorMed[nome]||0); // não altera horas
  });

  return {horasPorMed,valoresPorEsp,horasPorData};
}

function inicializarGraficos(){
  const ctx1=document.getElementById("chartHorasMedico").getContext('2d');
  chartHorasMedico = new Chart(ctx1,{type:'bar',data:{labels:[],datasets:[{label:'Horas',data:[]}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  const ctx2=document.getElementById("chartValoresEspecialidade").getContext('2d');
  chartValoresEspecialidade = new Chart(ctx2,{type:'pie',data:{labels:[],datasets:[{data:[]}]},options:{responsive:true}});
  const ctx3=document.getElementById("chartEvolucao").getContext('2d');
  chartEvolucao = new Chart(ctx3,{type:'line',data:{labels:[],datasets:[{label:'Horas diárias',data:[],fill:true,tension:0.3}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
  atualizarGraficosComVisiveis();
}

function atualizarGraficosComVisiveis(){
  const visPl = obterPlantoesVisiveis();
  const visEl = eletivasData;

  const ci=(document.getElementById("chartInicio").value||"");
  const cf=(document.getElementById("chartFim").value||"");

  let plFiltrado = visPl.slice();
  let elFiltrado = visEl.slice();

  if(ci || cf){
    plFiltrado = plFiltrado.filter(it=>{
      const d = (String(it.DATA||"")).split(" ")[0]||"";
      if(ci && d<ci) return false;
      if(cf && d>cf) return false;
      return true;
    });
    elFiltrado = elFiltrado.filter(it=>{
      const d = it["Data do procedimento"]||"";
      if(ci && d<ci) return false;
      if(cf && d>cf) return false;
      return true;
    });
  }

  const {horasPorMed,valoresPorEsp,horasPorData} = prepararDadosGraficos(plFiltrado,elFiltrado);

  const labelsH=Object.keys(horasPorMed).sort((a,b)=>horasPorMed[b]-horasPorMed[a]);
  chartHorasMedico.data.labels=labelsH;
  chartHorasMedico.data.datasets[0].data=labelsH.map(l=>Number(horasPorMed[l].toFixed(2)));
  chartHorasMedico.update();

  const labelsV=Object.keys(valoresPorEsp);
  chartValoresEspecialidade.data.labels=labelsV;
  chartValoresEspecialidade.data.datasets[0].data=labelsV.map(l=>Number(valoresPorEsp[l].toFixed(2)));
  chartValoresEspecialidade.update();

  const labelsD=Object.keys(horasPorData).filter(d=>d!=="").sort();
  chartEvolucao.data.labels=labelsD;
  chartEvolucao.data.datasets[0].data=labelsD.map(d=>Number(horasPorData[d].toFixed(2)));
  chartEvolucao.update();
}

// ---------- Auxiliares ----------
function obterPlantoesVisiveis(){ return plantoesData; }

function mapearEventosPlantao(data){
  return data.map(it=>({title:it["QUEM REALIZOU"]||"",start:it.DATA,allDay:true}));
}

function toggleCalendario(){
  calendarioVisivel=!calendarioVisivel;
  document.getElementById("calendar").style.display=calendarioVisivel?"block":"none";
  document.getElementById("plantoesTable").style.display=calendarioVisivel?"none":"table";
  if(calendarioVisivel && !calendarInstance){
    calendarInstance = new FullCalendar.Calendar(document.getElementById("calendar"),{
      initialView:'dayGridMonth',
      events: mapearEventosPlantao(plantoesData)
    });
    calendarInstance.render();
  }
}

function aplicarPeriodoGraficos(){atualizarGraficosComVisiveis();}

</script>
</body>
</html>
